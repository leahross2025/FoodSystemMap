---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`${SITE_TITLE} - Dashboard`} description={SITE_DESCRIPTION} />
		<script src="https://d3js.org/d3.v7.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	</head>
	<body>
		<nav class="navigation">
			<div class="nav-container">
				<a href="/" class="nav-link">‚Üê Back to Map</a>
				<h1>Survey Results Dashboard</h1>
			</div>
		</nav>

		<div class="hero-section">
			<h1>LA Food Systems Stakeholder Survey Results</h1>
		</div>
		
		<main class="dashboard-container">
			<!-- Summary Statistics -->
			<section class="summary-section">
				<div class="summary-cards" id="summary-cards">
					<div class="loading">Loading summary statistics...</div>
				</div>
			</section>

			<!-- Simple Goal Alignment Chart -->
			<section class="visualizations-grid">
				<div class="viz-container">
					<div class="viz-header">
						<h2>Primary Goals Distribution</h2>
						<p>Most common organizational goals</p>
					</div>
					<div class="viz-content" id="goals-chart">
						<div class="loading">Loading goals chart...</div>
					</div>
				</div>

				<div class="viz-container">
					<div class="viz-header">
						<h2>Organization Sectors</h2>
						<p>Types of organizations surveyed</p>
					</div>
					<div class="viz-content" id="sectors-chart">
						<div class="loading">Loading sectors chart...</div>
					</div>
				</div>

				<div class="viz-container full-width">
					<div class="viz-header">
						<h2>Collaboration Challenges</h2>
						<p>Most common barriers to collaboration</p>
					</div>
					<div class="viz-content" id="challenges-chart">
						<div class="loading">Loading challenges chart...</div>
					</div>
				</div>
			</section>
		</main>

		<Footer />

		<script>
			// Data processor class
			class SurveyDataProcessor {
				constructor(excelData) {
					this.rawData = excelData;
					this.processedData = this.parseExcel(excelData);
				}

				parseExcel(excelData) {
					try {
						// Parse the Excel file
						const workbook = XLSX.read(excelData, { type: 'array' });
						
						// Get the first worksheet
						const sheetName = workbook.SheetNames[0];
						const worksheet = workbook.Sheets[sheetName];
						
						// Convert to JSON with header normalization
						const jsonData = XLSX.utils.sheet_to_json(worksheet, {
							header: 1, // Get raw array data first
							defval: '' // Default value for empty cells
						});
						
						if (jsonData.length === 0) return [];
						
						// Get headers and normalize them
						const headers = jsonData[0].map(header => 
							String(header || '').trim().replace(/\s+/g, '_').replace(/[^\w]/g, '_')
						);
						
						// Convert data rows to objects
						const data = [];
						for (let i = 1; i < jsonData.length; i++) {
							const row = {};
							headers.forEach((header, index) => {
								row[header] = String(jsonData[i][index] || '').trim();
							});
							// Only add rows that have some data
							if (Object.values(row).some(val => val !== '')) {
								data.push(row);
							}
						}
						
						return data;
					} catch (error) {
						console.error('Error parsing Excel file:', error);
						return [];
					}
				}

				parseMultiSelect(field) {
					if (!field) return [];
					return field.split(',').map(item => item.trim()).filter(item => item.length > 0);
				}

				normalizeSector(sector) {
					if (!sector) return 'Unknown';
					const sectorMap = {
						'Nonprofit/CBO': 'Nonprofit',
						'Government Agency': 'Government',
						'Foundation': 'Foundation',
						'College/University': 'Academic'
					};
					return sectorMap[sector] || sector;
				}

				extractPrimaryDistrict(districtField) {
					if (!districtField) return 'Unknown';
					if (districtField.includes('Countywide')) return 'Countywide';
					const match = districtField.match(/(\d+)(st|nd|rd|th)\s+District/);
					return match ? `District ${match[1]}` : 'Unknown';
				}

				getSummaryStats() {
					const totalOrgs = this.processedData.length;
					const sectorCounts = {};
					const districtCounts = {};

					this.processedData.forEach(org => {
						const sector = this.normalizeSector(org.Sector);
						const district = this.extractPrimaryDistrict(org.Primary_Supervisorial_District__based_on_headquarters_address_);
						
						sectorCounts[sector] = (sectorCounts[sector] || 0) + 1;
						districtCounts[district] = (districtCounts[district] || 0) + 1;
					});

					return {
						totalOrganizations: totalOrgs,
						sectorBreakdown: sectorCounts,
						districtBreakdown: districtCounts
					};
				}

				getGoalData() {
					const goalCounts = {};
					this.processedData.forEach(org => {
						const primaryGoal = org.If_you_had_to_choose_the_goal_MOST_aligned_with_your_organization__which_one_would_it_be_;
						if (primaryGoal) {
							goalCounts[primaryGoal] = (goalCounts[primaryGoal] || 0) + 1;
						}
					});
					return goalCounts;
				}

				getChallengesData() {
					const challengeCounts = {};
					this.processedData.forEach(org => {
						// Try multiple possible column names for challenges
						const possibleChallengeFields = [
							'What_are_the_biggest_challenges_your_organization_faces_in_collaborating_with_others_in_the_food_system__Select_up_to_3_',
							'What_are_the_biggest_challenges_your_organization_faces_in_collaborating_with_others_in_the_food_system_',
							'Biggest_challenges_collaborating',
							'Challenges_collaborating',
							'Collaboration_challenges'
						];
						
						let challengesField = '';
						for (const field of possibleChallengeFields) {
							if (org[field]) {
								challengesField = org[field];
								break;
							}
						}
						
						// If no exact match, look for any field containing 'challenge' or 'collaborat'
						if (!challengesField) {
							const keys = Object.keys(org);
							const challengeKey = keys.find(key => 
								key.toLowerCase().includes('challenge') || 
								key.toLowerCase().includes('collaborat')
							);
							if (challengeKey) {
								challengesField = org[challengeKey];
							}
						}
						
						if (challengesField) {
							const challenges = this.parseMultiSelect(challengesField);
							challenges.forEach(challenge => {
								if (challenge && challenge.trim()) {
									challengeCounts[challenge] = (challengeCounts[challenge] || 0) + 1;
								}
							});
						}
					});
					
					console.log('Challenges data found:', challengeCounts);
					return challengeCounts;
				}
			}

			// Simple bar chart function
			function createBarChart(selector, data, title) {
				const container = d3.select(selector);
				container.selectAll("*").remove();

				const margin = { top: 20, right: 20, bottom: 160, left: 40 };
				const width = 400 - margin.left - margin.right;
				const height = 400 - margin.top - margin.bottom;

				const svg = container.append("svg")
					.attr("width", width + margin.left + margin.right)
					.attr("height", height + margin.top + margin.bottom);

				const g = svg.append("g")
					.attr("transform", `translate(${margin.left},${margin.top})`);

				const dataArray = Object.entries(data).map(([key, value]) => ({
					label: key.length > 30 ? key.substring(0, 30) + "..." : key,
					value: value,
					fullLabel: key
				})).sort((a, b) => b.value - a.value).slice(0, 8);

				const xScale = d3.scaleBand()
					.domain(dataArray.map(d => d.label))
					.range([0, width])
					.padding(0.1);

				const yScale = d3.scaleLinear()
					.domain([0, d3.max(dataArray, d => d.value)])
					.range([height, 0]);

				// Create color scale for bars
				const colorScale = d3.scaleOrdinal()
					.range(['#38a169', '#3182ce', '#805ad5', '#dd6b20', '#e53e3e', '#38b2ac', '#d69e2e', '#f56565']);

				// Create bars
				g.selectAll(".bar")
					.data(dataArray)
					.enter().append("rect")
					.attr("class", "bar")
					.attr("x", d => xScale(d.label))
					.attr("width", xScale.bandwidth())
					.attr("y", d => yScale(d.value))
					.attr("height", d => height - yScale(d.value))
					.attr("fill", (d, i) => colorScale(i))
					.on("mouseover", function(event, d) {
						const originalColor = d3.select(this).attr("fill");
						d3.select(this).attr("fill", d3.color(originalColor).darker(0.3));
						
						// Simple tooltip
						const tooltip = d3.select("body").append("div")
							.attr("class", "tooltip")
							.style("position", "absolute")
							.style("background", "rgba(0,0,0,0.8)")
							.style("color", "white")
							.style("padding", "8px")
							.style("border-radius", "4px")
							.style("font-size", "12px")
							.style("pointer-events", "none")
							.style("z-index", "1000")
							.html(`<strong>${d.fullLabel}</strong><br/>Count: ${d.value}`)
							.style("left", (event.pageX + 10) + "px")
							.style("top", (event.pageY - 10) + "px");
					})
					.on("mouseout", function(event, d) {
						const index = dataArray.indexOf(d);
						d3.select(this).attr("fill", colorScale(index));
						d3.selectAll(".tooltip").remove();
					});

				// Add value labels
				g.selectAll(".label")
					.data(dataArray)
					.enter().append("text")
					.attr("class", "label")
					.attr("x", d => xScale(d.label) + xScale.bandwidth() / 2)
					.attr("y", d => yScale(d.value) - 5)
					.attr("text-anchor", "middle")
					.style("font-size", "12px")
					.style("fill", "#2d3748")
					.text(d => d.value);

				// Add x-axis
				g.append("g")
					.attr("transform", `translate(0,${height})`)
					.call(d3.axisBottom(xScale))
					.selectAll("text")
					.style("text-anchor", "end")
					.attr("dx", "-.8em")
					.attr("dy", ".15em")
					.attr("transform", "rotate(-45)")
					.style("font-size", "10px");

				// Add y-axis
				g.append("g")
					.call(d3.axisLeft(yScale));
			}

			// Simple pie chart function
			function createPieChart(selector, data, title) {
				const container = d3.select(selector);
				container.selectAll("*").remove();

				const width = 300;
				const height = 300;
				const radius = Math.min(width, height) / 2 - 20;

				const svg = container.append("svg")
					.attr("width", width)
					.attr("height", height)
					.style("display", "block")
					.style("margin", "0 auto");

				const g = svg.append("g")
					.attr("transform", `translate(${width/2},${height/2})`);

				const color = d3.scaleOrdinal()
					.range(['#38a169', '#3182ce', '#805ad5', '#dd6b20', '#e53e3e']);

				const pie = d3.pie()
					.value(d => d.value);

				const arc = d3.arc()
					.innerRadius(0)
					.outerRadius(radius);

				const dataArray = Object.entries(data).map(([key, value]) => ({
					label: key,
					value: value
				}));

				const arcs = g.selectAll(".arc")
					.data(pie(dataArray))
					.enter().append("g")
					.attr("class", "arc");

				arcs.append("path")
					.attr("d", arc)
					.attr("fill", (d, i) => color(i))
					.on("mouseover", function(event, d) {
						const tooltip = d3.select("body").append("div")
							.attr("class", "tooltip")
							.style("position", "absolute")
							.style("background", "rgba(0,0,0,0.8)")
							.style("color", "white")
							.style("padding", "8px")
							.style("border-radius", "4px")
							.style("font-size", "12px")
							.style("pointer-events", "none")
							.style("z-index", "1000")
							.html(`<strong>${d.data.label}</strong><br/>Count: ${d.data.value}`)
							.style("left", (event.pageX + 10) + "px")
							.style("top", (event.pageY - 10) + "px");
					})
					.on("mouseout", function() {
						d3.selectAll(".tooltip").remove();
					});

				arcs.append("text")
					.attr("transform", d => `translate(${arc.centroid(d)})`)
					.attr("dy", ".35em")
					.style("text-anchor", "middle")
					.style("font-size", "12px")
					.style("fill", "white")
					.text(d => d.data.value > 1 ? d.data.value : '');
			}

			async function loadSurveyData() {
				try {
					const response = await fetch('/FINAL- Food Systems Stakeholder Survey  (Responses).xlsx');
					const arrayBuffer = await response.arrayBuffer();
					const uint8Array = new Uint8Array(arrayBuffer);
					return new SurveyDataProcessor(uint8Array);
				} catch (error) {
					console.error('Error loading survey data:', error);
					return null;
				}
			}

			function createSummaryCards(stats) {
				const container = document.getElementById('summary-cards');
				
				const cards = [
					{
						title: 'Total Organizations',
						value: stats.totalOrganizations,
						subtitle: 'Survey Respondents'
					},
					{
						title: 'Nonprofit/CBOs',
						value: stats.sectorBreakdown.Nonprofit || 0,
						subtitle: `${Math.round((stats.sectorBreakdown.Nonprofit || 0) / stats.totalOrganizations * 100)}% of total`
					},
					{
						title: 'Government Agencies',
						value: stats.sectorBreakdown.Government || 0,
						subtitle: `${Math.round((stats.sectorBreakdown.Government || 0) / stats.totalOrganizations * 100)}% of total`
					},
					{
						title: 'Districts Covered',
						value: Object.keys(stats.districtBreakdown).length,
						subtitle: 'Supervisorial Districts'
					}
				];

				container.innerHTML = cards.map(card => `
					<div class="summary-card">
						<div class="card-value">${card.value}</div>
						<div class="card-title">${card.title}</div>
						<div class="card-subtitle">${card.subtitle}</div>
					</div>
				`).join('');
			}

			async function initializeDashboard() {
				try {
					const dataProcessor = await loadSurveyData();
					if (!dataProcessor) {
						throw new Error('Failed to load survey data');
					}

					// Debug: Log the first few rows to see the structure
					console.log('Parsed data sample:', dataProcessor.processedData.slice(0, 3));
					console.log('Available columns:', Object.keys(dataProcessor.processedData[0] || {}));

					// Create summary cards
					createSummaryCards(dataProcessor.getSummaryStats());

					// Create visualizations
					createBarChart('#goals-chart', dataProcessor.getGoalData(), 'Primary Goals');
					createPieChart('#sectors-chart', dataProcessor.getSummaryStats().sectorBreakdown, 'Organization Sectors');
					createBarChart('#challenges-chart', dataProcessor.getChallengesData(), 'Collaboration Challenges');

				} catch (error) {
					console.error('Error initializing dashboard:', error);
					document.querySelectorAll('.loading').forEach(el => {
						el.textContent = 'Error loading visualization';
						el.style.color = '#e53e3e';
					});
				}
			}

			// Initialize dashboard when page loads
			document.addEventListener('DOMContentLoaded', initializeDashboard);
		</script>
	</body>
</html>

<style>
	.navigation {
		background: #2d3748;
		color: white;
		padding: 1rem 0;
		position: sticky;
		top: 0;
		z-index: 100;
	}

	.nav-container {
		max-width: 1200px;
		margin: 0 auto;
		padding: 0 20px;
		display: flex;
		align-items: center;
		gap: 2rem;
	}

	.nav-link {
		color: #90cdf4;
		text-decoration: none;
		font-weight: 500;
		transition: color 0.2s;
	}

	.nav-link:hover {
		color: white;
	}

	.navigation h1 {
		margin: 0;
		font-size: 1.5rem;
		font-weight: 600;
	}

	.hero-section {
		text-align: center;
		padding: 60px 20px;
		background: linear-gradient(135deg, rgba(122, 139, 92, 0.49) 0%, rgba(27, 56, 34, 0.36) 100%);
		color: white;
		margin-bottom: 40px;
	}
	
	.hero-section h1 {
		font-size: 3rem;
		margin: 0 0 20px 0;
		font-weight: bold;
	}
	
	.hero-section p {
		font-size: 1.2rem;
		margin: 0;
		max-width: 600px;
		margin-left: auto;
		margin-right: auto;
		line-height: 1.6;
	}

	.dashboard-container {
		max-width: 1200px;
		margin: 0 auto;
		padding: 0 20px;
	}

	.summary-section {
		margin-bottom: 40px;
	}

	.summary-cards {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
		gap: 20px;
		margin-bottom: 40px;
	}

	.summary-card {
		background: white;
		padding: 24px;
		border-radius: 12px;
		box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		text-align: center;
		border-left: 4px solid #38a169;
	}

	.card-value {
		font-size: 2.5rem;
		font-weight: bold;
		color: #2d3748;
		margin-bottom: 8px;
	}

	.card-title {
		font-size: 1.1rem;
		font-weight: 600;
		color: #4a5568;
		margin-bottom: 4px;
	}

	.card-subtitle {
		font-size: 0.9rem;
		color: #718096;
	}

	.visualizations-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
		gap: 30px;
		margin-bottom: 40px;
	}

	.viz-container {
		background: white;
		border-radius: 12px;
		box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		overflow: hidden;
	}

	.viz-container.full-width {
		grid-column: 1 / -1;
	}

	.viz-header {
		padding: 24px 24px 16px 24px;
		border-bottom: 1px solid #e2e8f0;
	}

	.viz-header h2 {
		margin: 0 0 8px 0;
		font-size: 1.5rem;
		color: #2d3748;
		font-weight: 600;
	}

	.viz-header p {
		margin: 0;
		color: #718096;
		font-size: 0.95rem;
	}

	.viz-content {
		padding: 24px;
		min-height: 350px;
		position: relative;
		display: flex;
		justify-content: center;
		align-items: center;
	}

	.loading {
		color: #718096;
		font-style: italic;
	}

	/* Responsive Design */
	@media (max-width: 768px) {
		.hero-section {
			padding: 40px 15px;
		}
		
		.hero-section h1 {
			font-size: 2.2rem;
		}
		
		.hero-section p {
			font-size: 1rem;
		}

		.dashboard-container {
			padding: 0 15px;
		}

		.visualizations-grid {
			grid-template-columns: 1fr;
			gap: 20px;
		}

		.viz-container.full-width {
			grid-column: 1;
		}

		.summary-cards {
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
		}

		.summary-card {
			padding: 20px;
		}

		.card-value {
			font-size: 2rem;
		}

		.viz-content {
			padding: 16px;
			min-height: 300px;
		}

		.nav-container {
			padding: 0 15px;
		}

		.navigation h1 {
			font-size: 1.2rem;
		}
	}
</style>
